<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æ ¼å¼è½¬æ¢å™¨</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
		}
		body {
			font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 20px;
		}

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #e8f5e9;
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-hint {
            font-size: 14px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            min-width: auto;
        }

        .progress-container {
            margin-top: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-info {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .file-list {
            margin-top: 30px;
            display: none;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .file-item.renamed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .file-original {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #333;
            font-size: 24px;
        }

        .close {
            font-size: 32px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .sort-info {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        .input-hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-section h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .preview-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }

        .preview-item strong {
            color: #28a745;
        }

        .preview-more {
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        /* å¯ç¼–è¾‘æ–‡ä»¶åæ ·å¼ */
        .file-name.editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
            display: inline-block;
            min-width: 200px;
        }

        .file-name.editable:hover {
            background: #f0f0f0;
        }

        .file-name.editable:hover::after {
            content: 'âœï¸';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.6;
        }

        .file-name.editing {
            background: #fff3cd;
            border: 2px solid #ffc107;
            outline: none;
            cursor: text;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .file-name.editing:hover::after {
            display: none;
        }

        .file-name.editable::before {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 8px;
            right: 8px;
            height: 1px;
            background: transparent;
            transition: background 0.2s;
        }

        .file-name.editable:hover::before {
            background: #667eea;
        }

        /* ç¼–è¾‘æç¤ºæ–‡å­— */
        .edit-hint {
            font-size: 12px;
            color: #999;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .modal-content {
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ éŸ³é¢‘æ ¼å¼è½¬æ¢å™¨</h1>
        <p class="subtitle">å°†ä»»æ„éŸ³é¢‘æ ¼å¼è½¬æ¢ä¸ºå°çŒ´çš®çš®å¯ä»¥æ’­æ”¾çš„æ ¼å¼</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</div>
            <div class="upload-hint">æ”¯æŒ MP3, WAV, M4A, OGG ç­‰å¸¸è§éŸ³é¢‘æ ¼å¼</div>
        </div>

        <input type="file" id="fileInput" multiple accept="audio/*">

        <div class="button-group">
            <button class="btn-primary" id="convertBtn" disabled>ğŸ”„ å¼€å§‹è½¬æ¢</button>
            <button class="btn-secondary" id="renameBtn" disabled>âœï¸ æ‰¹é‡é‡å‘½å</button>
            <button class="btn-success" id="downloadAllBtn" disabled>ğŸ“¦ æ‰“åŒ…ä¸‹è½½</button>
            <button class="btn-danger" id="clearBtn" disabled>ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="progress-info" id="progressInfo">å‡†å¤‡è½¬æ¢...</div>
        </div>

        <div class="file-list" id="fileList"></div>
    </div>

    <!-- é‡å‘½åæ¨¡æ€æ¡† -->
    <div id="renameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ æ‰¹é‡é‡å‘½å</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>

            <div class="form-group">
                <label for="sortMethod">æ’åºæ–¹å¼ï¼š</label>
                <select id="sortMethod">
                    <option value="name-asc">æ–‡ä»¶å (å‡åº)</option>
                    <option value="name-desc">æ–‡ä»¶å (é™åº)</option>
                    <option value="date-asc">ä¿®æ”¹æ—¶é—´ (æœ€æ—©ä¼˜å…ˆ)</option>
                    <option value="date-desc">ä¿®æ”¹æ—¶é—´ (æœ€æ–°ä¼˜å…ˆ)</option>
                    <option value="size-asc">æ–‡ä»¶å¤§å° (ä»å°åˆ°å¤§)</option>
                    <option value="size-desc">æ–‡ä»¶å¤§å° (ä»å¤§åˆ°å°)</option>
                </select>
                <div class="sort-info" id="sortInfo">
                    <strong>å½“å‰æ’åºï¼š</strong>æ–‡ä»¶å (å‡åº) - Aåˆ°Zï¼Œæ•°å­—ä»å°åˆ°å¤§
                </div>
            </div>

            <div class="form-group">
                <label for="startNumber">èµ·å§‹ç¼–å·ï¼ˆ5ä½æ•°å­—ï¼‰ï¼š</label>
                <input type="text" id="startNumber" placeholder="ä¾‹å¦‚ï¼š00001" maxlength="5" value="00001">
                <div class="input-hint">æ–‡ä»¶å°†è¢«å‘½åä¸º Rec00001.wav, Rec00002.wav ...</div>
                <div class="error-message" id="numberError">è¯·è¾“å…¥5ä½æ•°å­—</div>
            </div>

            <div class="preview-section">
                <h3>ğŸ” é‡å‘½åé¢„è§ˆï¼ˆå‰5ä¸ªï¼‰ï¼š</h3>
                <div class="preview-list" id="previewList"></div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" id="cancelRenameBtn">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirmRenameBtn">ç¡®è®¤é‡å‘½å</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const renameBtn = document.getElementById('renameBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const clearBtn = document.getElementById('clearBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressInfo = document.getElementById('progressInfo');
        const fileList = document.getElementById('fileList');

        // æ¨¡æ€æ¡†å…ƒç´ 
        const renameModal = document.getElementById('renameModal');
        const closeModal = document.getElementById('closeModal');
        const cancelRenameBtn = document.getElementById('cancelRenameBtn');
        const confirmRenameBtn = document.getElementById('confirmRenameBtn');
        const sortMethod = document.getElementById('sortMethod');
        const sortInfo = document.getElementById('sortInfo');
        const startNumberInput = document.getElementById('startNumber');
        const numberError = document.getElementById('numberError');
        const previewList = document.getElementById('previewList');

        let selectedFiles = [];
        let convertedFiles = [];
        let isRenamed = false;

        // æ’åºæ–¹å¼è¯´æ˜
        const sortDescriptions = {
            'name-asc': 'æ–‡ä»¶å (å‡åº) - Aåˆ°Zï¼Œæ•°å­—ä»å°åˆ°å¤§',
            'name-desc': 'æ–‡ä»¶å (é™åº) - Zåˆ°Aï¼Œæ•°å­—ä»å¤§åˆ°å°',
            'date-asc': 'ä¿®æ”¹æ—¶é—´ (æœ€æ—©ä¼˜å…ˆ) - æœ€æ—©ä¿®æ”¹çš„æ–‡ä»¶æ’åœ¨å‰é¢',
            'date-desc': 'ä¿®æ”¹æ—¶é—´ (æœ€æ–°ä¼˜å…ˆ) - æœ€æ–°ä¿®æ”¹çš„æ–‡ä»¶æ’åœ¨å‰é¢',
            'size-asc': 'æ–‡ä»¶å¤§å° (ä»å°åˆ°å¤§) - å°æ–‡ä»¶æ’åœ¨å‰é¢',
            'size-desc': 'æ–‡ä»¶å¤§å° (ä»å¤§åˆ°å°) - å¤§æ–‡ä»¶æ’åœ¨å‰é¢'
        };

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        uploadArea.addEventListener('click', () => fileInput.click());

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type.startsWith('audio/'));
            
            if (selectedFiles.length === 0) {
                alert('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            convertBtn.disabled = false;
            progressInfo.textContent = `å·²é€‰æ‹© ${selectedFiles.length} ä¸ªéŸ³é¢‘æ–‡ä»¶`;
            progressInfo.style.color = '#667eea';
            progressContainer.style.display = 'block';
        }

        // è½¬æ¢æŒ‰é’®
        convertBtn.addEventListener('click', async () => {
            convertBtn.disabled = true;
            convertedFiles = [];
            isRenamed = false;
            
            progressContainer.style.display = 'block';
            fileList.style.display = 'none';

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                progressFill.style.width = ((i / selectedFiles.length) * 100) + '%';
                progressFill.textContent = Math.round((i / selectedFiles.length) * 100) + '%';
                progressInfo.textContent = `æ­£åœ¨è½¬æ¢: ${file.name} (${i + 1}/${selectedFiles.length})`;

                try {
                    const convertedBlob = await convertAudio(file);
                    const convertedFile = new File([convertedBlob], file.name.replace(/\.[^/.]+$/, '.wav'), {
                        type: 'audio/wav',
                        lastModified: file.lastModified
                    });
                    // ä¿å­˜åŸå§‹æ–‡ä»¶å¤§å°
                    convertedFile.originalSize = file.size;
                    convertedFiles.push(convertedFile);
                } catch (error) {
                    console.error('è½¬æ¢å¤±è´¥:', file.name, error);
                    progressInfo.textContent = `è½¬æ¢å¤±è´¥: ${file.name}`;
                    progressInfo.style.color = '#dc3545';
                }
            }

            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            progressInfo.textContent = `âœ… è½¬æ¢å®Œæˆï¼å…± ${convertedFiles.length} ä¸ªæ–‡ä»¶`;
            progressInfo.style.color = '#28a745';

            updateFileListDisplay();
            updateButtons();
        });

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            renameBtn.disabled = convertedFiles.length === 0;
            downloadAllBtn.disabled = convertedFiles.length === 0;
            clearBtn.disabled = convertedFiles.length === 0;
        }

		// æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ - æ·»åŠ æ‰‹åŠ¨é‡å‘½ååŠŸèƒ½
		function updateFileListDisplay() {
			if (convertedFiles.length === 0) {
				fileList.style.display = 'none';
				return;
			}

			fileList.style.display = 'block';
			fileList.innerHTML = '<div class="edit-hint">ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ–‡ä»¶åå¯ç›´æ¥ç¼–è¾‘ï¼ŒæŒ‰å›è½¦ä¿å­˜ï¼ŒæŒ‰ESCå–æ¶ˆ</div>';

			convertedFiles.forEach((file, index) => {
				const fileItem = document.createElement('div');
				fileItem.className = 'file-item' + (isRenamed ? ' renamed' : '');
				
				const fileInfo = document.createElement('div');
				fileInfo.className = 'file-info';
				
				const fileName = document.createElement('div');
				fileName.className = 'file-name editable';
				fileName.contentEditable = false;
				fileName.textContent = file.name;
				fileName.title = 'ç‚¹å‡»ç¼–è¾‘æ–‡ä»¶å';
				
				// ç‚¹å‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼
				fileName.addEventListener('click', () => {
					if (fileName.contentEditable === 'false') {
						fileName.contentEditable = true;
						fileName.classList.add('editing');
						fileName.focus();
						
						// é€‰ä¸­æ–‡ä»¶åï¼ˆä¸åŒ…æ‹¬æ‰©å±•åï¼‰
						const range = document.createRange();
						const selection = window.getSelection();
						const textNode = fileName.firstChild;
						const nameWithoutExt = file.name.replace(/\.wav$/, '');
						range.setStart(textNode, 0);
						range.setEnd(textNode, nameWithoutExt.length);
						selection.removeAllRanges();
						selection.addRange(range);
					}
				});
				
				// å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
				fileName.addEventListener('blur', () => {
					saveFileName(fileName, index, fileItem);
				});
				
				// æŒ‰å›è½¦ä¿å­˜ï¼ŒæŒ‰ESCå–æ¶ˆ
				fileName.addEventListener('keydown', (e) => {
					if (e.key === 'Enter') {
						e.preventDefault();
						fileName.blur();
					} else if (e.key === 'Escape') {
						fileName.textContent = file.name;
						fileName.contentEditable = false;
						fileName.classList.remove('editing');
					}
				});
				
				// é˜²æ­¢è¾“å…¥æ¢è¡Œ
				fileName.addEventListener('paste', (e) => {
					e.preventDefault();
					const text = e.clipboardData.getData('text/plain').replace(/\n/g, '');
					document.execCommand('insertText', false, text);
				});
				
				fileInfo.appendChild(fileName);
				
				if (file.originalName && file.originalName !== file.name) {
					const originalName = document.createElement('div');
					originalName.className = 'file-original';
					originalName.textContent = `åŸæ–‡ä»¶å: ${file.originalName}`;
					fileInfo.appendChild(originalName);
				}
				
				const fileActions = document.createElement('div');
				fileActions.className = 'file-actions';
				
				const downloadBtn = document.createElement('button');
				downloadBtn.className = 'btn-success btn-small';
				downloadBtn.textContent = 'ä¸‹è½½';
				downloadBtn.onclick = () => downloadFile(convertedFiles[index]); // ä¿®æ”¹ï¼šä½¿ç”¨ç´¢å¼•è·å–æœ€æ–°çš„æ–‡ä»¶å¯¹è±¡
				
				fileActions.appendChild(downloadBtn);
				fileItem.appendChild(fileInfo);
				fileItem.appendChild(fileActions);
				fileList.appendChild(fileItem);
			});
		}


		// ä¿å­˜æ–‡ä»¶å
		function saveFileName(element, index, fileItem) {
			const file = convertedFiles[index];
			let newName = element.textContent.trim();
			
			// éªŒè¯æ–‡ä»¶å
			if (!newName) {
				alert('æ–‡ä»¶åä¸èƒ½ä¸ºç©ºï¼');
				element.textContent = file.name;
				element.contentEditable = false;
				element.classList.remove('editing');
				return;
			}
			
			// ç§»é™¤éæ³•å­—ç¬¦
			newName = newName.replace(/[<>:"/\\|?*]/g, '');
			
			// ç¡®ä¿æœ‰.wavæ‰©å±•å
			if (!newName.toLowerCase().endsWith('.wav')) {
				newName += '.wav';
			}
			
			// æ£€æŸ¥é‡å
			const isDuplicate = convertedFiles.some((f, i) => 
				i !== index && f.name.toLowerCase() === newName.toLowerCase()
			);
			
			if (isDuplicate) {
				alert('æ–‡ä»¶åå·²å­˜åœ¨ï¼');
				element.textContent = file.name;
				element.contentEditable = false;
				element.classList.remove('editing');
				return;
			}
			
			// åˆ›å»ºæ–°çš„Fileå¯¹è±¡
			if (newName !== file.name) {
				const originalName = file.originalName || file.name;
				const newFile = new File([file], newName, {
					type: file.type,
					lastModified: file.lastModified
				});
				newFile.originalName = originalName;
				newFile.originalSize = file.originalSize || file.size;
				
				// æ›´æ–°æ•°ç»„ä¸­çš„æ–‡ä»¶å¯¹è±¡
				convertedFiles[index] = newFile;
				isRenamed = true;
				
				// æ›´æ–°æ–‡ä»¶é¡¹æ ·å¼
				fileItem.classList.add('renamed');
				
				progressInfo.textContent = `âœ… å·²é‡å‘½å: ${originalName} â†’ ${newName}`;
				progressInfo.style.color = '#28a745';
			}
			
			element.textContent = newName;
			element.contentEditable = false;
			element.classList.remove('editing');
		}


        // å•ä¸ªæ–‡ä»¶ä¸‹è½½
        function downloadFile(file) {
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ‰“åŒ…ä¸‹è½½
        downloadAllBtn.addEventListener('click', async () => {
            downloadAllBtn.disabled = true;
            progressInfo.textContent = 'æ­£åœ¨æ‰“åŒ…æ–‡ä»¶...';
            progressInfo.style.color = '#667eea';

            const zip = new JSZip();
            
            convertedFiles.forEach(file => {
                zip.file(file.name, file);
            });

            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted_audio_files.zip';
            a.click();
            URL.revokeObjectURL(url);

            progressInfo.textContent = 'âœ… æ‰“åŒ…ä¸‹è½½å®Œæˆï¼';
            progressInfo.style.color = '#28a745';
            downloadAllBtn.disabled = false;
        });

        // æ¸…ç©ºåˆ—è¡¨
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
                selectedFiles = [];
                convertedFiles = [];
                isRenamed = false;
                fileList.innerHTML = '';
                fileList.style.display = 'none';
                progressContainer.style.display = 'none';
                convertBtn.disabled = true;
                updateButtons();
                fileInput.value = '';
            }
        });

        // æ‰“å¼€é‡å‘½åæ¨¡æ€æ¡†
        renameBtn.addEventListener('click', () => {
            renameModal.style.display = 'block';
            updatePreview();
        });

        // å…³é—­æ¨¡æ€æ¡†
        closeModal.addEventListener('click', closeRenameModal);
        cancelRenameBtn.addEventListener('click', closeRenameModal);

        function closeRenameModal() {
            renameModal.style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target === renameModal) {
                closeRenameModal();
            }
        });

        // æ’åºæ–¹å¼æ”¹å˜
        sortMethod.addEventListener('change', () => {
            sortInfo.innerHTML = `<strong>å½“å‰æ’åºï¼š</strong>${sortDescriptions[sortMethod.value]}`;
            updatePreview();
        });

        // èµ·å§‹ç¼–å·è¾“å…¥éªŒè¯
        startNumberInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '');
            validateInput();
            updatePreview();
        });

        // éªŒè¯è¾“å…¥
        function validateInput() {
            const value = startNumberInput.value;
            if (value.length !== 5) {
                numberError.style.display = 'block';
                return false;
            }
            numberError.style.display = 'none';
            return true;
        }

        // æ–‡ä»¶æ’åºå‡½æ•°
        function sortFiles(files, method) {
            const sorted = [...files];
            
            switch(method) {
                case 'name-asc':
                    sorted.sort((a, b) => {
                        const nameA = a.originalName || a.name;
                        const nameB = b.originalName || b.name;
                        return nameA.localeCompare(nameB, 'zh-CN', { numeric: true });
                    });
                    break;
                    
                case 'name-desc':
                    sorted.sort((a, b) => {
                        const nameA = a.originalName || a.name;
                        const nameB = b.originalName || b.name;
                        return nameB.localeCompare(nameA, 'zh-CN', { numeric: true });
                    });
                    break;
                    
                case 'date-asc':
                    sorted.sort((a, b) => a.lastModified - b.lastModified);
                    break;
                    
                case 'date-desc':
                    sorted.sort((a, b) => b.lastModified - a.lastModified);
                    break;
                    
                case 'size-asc':
                    sorted.sort((a, b) => (a.originalSize || a.size) - (b.originalSize || b.size));
                    break;
                    
                case 'size-desc':
                    sorted.sort((a, b) => (b.originalSize || b.size) - (a.originalSize || a.size));
                    break;
            }
            
            return sorted;
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const startNum = parseInt(startNumberInput.value) || 1;
            const sorted = sortFiles(convertedFiles, sortMethod.value);
            
            previewList.innerHTML = '';
            
            const previewCount = Math.min(5, sorted.length);
            for (let i = 0; i < previewCount; i++) {
                const file = sorted[i];
                const newName = `Rec${String(startNum + i).padStart(5, '0')}.wav`;
                const originalName = file.originalName || file.name;
                
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `${originalName} â†’ <strong>${newName}</strong>`;
                previewList.appendChild(item);
            }
            
            if (sorted.length > 5) {
                const more = document.createElement('div');
                more.className = 'preview-more';
                more.textContent = `... è¿˜æœ‰ ${sorted.length - 5} ä¸ªæ–‡ä»¶`;
                previewList.appendChild(more);
            }
        }

        // ç¡®è®¤é‡å‘½å
        confirmRenameBtn.addEventListener('click', () => {
            if (!validateInput()) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„5ä½èµ·å§‹ç¼–å·ï¼');
                return;
            }

            const startNum = parseInt(startNumberInput.value);
            const sorted = sortFiles(convertedFiles, sortMethod.value);
            
            // æ‰§è¡Œé‡å‘½å
            convertedFiles = sorted.map((file, index) => {
                const newName = `Rec${String(startNum + index).padStart(5, '0')}.wav`;
                const originalName = file.originalName || file.name;
                
                const newFile = new File([file], newName, {
                    type: file.type,
                    lastModified: file.lastModified
                });
                newFile.originalName = originalName;
                newFile.originalSize = file.originalSize || file.size;
                
                return newFile;
            });

            isRenamed = true;
            updateFileListDisplay();
            closeRenameModal();
            
            progressInfo.textContent = `âœ… æ‰¹é‡é‡å‘½åå®Œæˆï¼å…± ${convertedFiles.length} ä¸ªæ–‡ä»¶`;
            progressInfo.style.color = '#28a745';
        });

        // éŸ³é¢‘è½¬æ¢æ ¸å¿ƒå‡½æ•°
        async function convertAudio(file) {
            return new Promise((resolve, reject) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                        // åˆ›å»ºç¦»çº¿éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œè®¾ç½®ä¸º16kHzå•å£°é“
                        const offlineContext = new OfflineAudioContext(
                            1,  // å•å£°é“
                            audioBuffer.duration * 16000,  // 16kHzé‡‡æ ·ç‡
                            16000  // 16kHz
                        );

                        // åˆ›å»ºéŸ³é¢‘æº
                        const source = offlineContext.createBufferSource();
                        source.buffer = audioBuffer;

                        // å¦‚æœåŸéŸ³é¢‘æ˜¯ç«‹ä½“å£°ï¼Œéœ€è¦è½¬æ¢ä¸ºå•å£°é“
                        if (audioBuffer.numberOfChannels > 1) {
                            const merger = offlineContext.createChannelMerger(1);
                            const splitter = offlineContext.createChannelSplitter(audioBuffer.numberOfChannels);
                            
                            source.connect(splitter);
                            
                            // æ··åˆæ‰€æœ‰å£°é“åˆ°å•å£°é“
                            for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
                                const gain = offlineContext.createGain();
                                gain.gain.value = 1 / audioBuffer.numberOfChannels;
                                splitter.connect(gain, i);
                                gain.connect(merger, 0, 0);
                            }
                            
                            merger.connect(offlineContext.destination);
                        } else {
                            source.connect(offlineContext.destination);
                        }

                        source.start(0);

                        // æ¸²æŸ“éŸ³é¢‘
                        const renderedBuffer = await offlineContext.startRendering();

                        // è½¬æ¢ä¸ºWAVæ ¼å¼
                        const wavBlob = audioBufferToWav(renderedBuffer);
                        resolve(wavBlob);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // å°†AudioBufferè½¬æ¢ä¸ºWAVæ ¼å¼
        function audioBufferToWav(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2;
            const arrayBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(arrayBuffer);
            const channels = [];
            let offset = 0;
            let pos = 0;

            // å†™å…¥WAVæ–‡ä»¶å¤´
            setUint32(0x46464952); // "RIFF"
            setUint32(36 + length); // æ–‡ä»¶é•¿åº¦
            setUint32(0x45564157); // "WAVE"

            // fmtå­å—
            setUint32(0x20746d66); // "fmt "
            setUint32(16); // å­å—å¤§å°
            setUint16(1); // éŸ³é¢‘æ ¼å¼ (PCM)
            setUint16(buffer.numberOfChannels); // å£°é“æ•°
            setUint32(buffer.sampleRate); // é‡‡æ ·ç‡
            setUint32(buffer.sampleRate * buffer.numberOfChannels * 2); // å­—èŠ‚ç‡
            setUint16(buffer.numberOfChannels * 2); // å—å¯¹é½
            setUint16(16); // ä½æ·±åº¦

            // dataå­å—
            setUint32(0x61746164); // "data"
            setUint32(length); // æ•°æ®é•¿åº¦

            // å†™å…¥éŸ³é¢‘æ•°æ®
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }

            while (pos < buffer.length) {
                for (let i = 0; i < buffer.numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][pos]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset, sample, true);
                    offset += 2;
                }
                pos++;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });

            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }

            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
    </script>
	<!-- ä¸è’œå­è®¿é—®ç»Ÿè®¡ -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<span id="busuanzi_container_site_pv">
    ğŸ‘ï¸ æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span>
</span>
<br>
<span id="busuanzi_container_site_uv">
    ğŸ‘¤ æ€»è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span>
</span>
</body>
</html>

